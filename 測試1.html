<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>租稅馬拉松小遊戲</title>
  <style>
    body { margin:0; background:#f0f0f0; font-family:Arial; }
    canvas { display:block; margin:0 auto; background:#000; }
    #quizBox, #passScreen {
      position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
      background: white; padding: 20px; border: 2px solid #333; display: none;
    }
    #quizBox button { margin-top: 10px; }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  
  <div id="quizBox">
    <div id="question"></div>
    <input type="text" id="answer" placeholder="輸入答案..." />
    <button onclick="checkAnswer()">送出</button>
  </div>
  
  <div id="passScreen">
    <h2>恭喜答對三題！</h2>
    <p>請工作人員輸入通行碼：</p>
    <input type="password" id="passcode" placeholder="輸入通行碼" />
    <button onclick="checkPasscode()">確認</button>
    <p id="passMessage"></p>
  </div>
  
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// 玩家物件
let player = { x:50, y:180, w:50, h:50 };
let keys = {};
let obstacles = [];
let frame = 0;
let score = 0;

let questions = [
  { q:"請問使用雲端發票有什麼好處？(輸入:方便)", a:"方便" },
  { q:"地價稅自用住宅用地稅率是否較低？(輸入:是)", a:"是" },
  { q:"請問租稅宣導的目的？(輸入:宣導)", a:"宣導" }
];

let currentQuestion = null;

document.addEventListener("keydown", e=>{ keys[e.key]=true; });
document.addEventListener("keyup", e=>{ keys[e.key]=false; });

function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 玩家移動
  if(keys["ArrowUp"] && player.y>0) player.y -=3;
  if(keys["ArrowDown"] && player.y<canvas.height-player.h) player.y +=3;
  
  // 畫玩家
  ctx.fillStyle="blue";
  ctx.fillRect(player.x, player.y, player.w, player.h);
  
  // 生成素材
  frame++;
  if(frame % 120 ===0){
    obstacles.push({ x:canvas.width, y:Math.random()*350, r:20 });
  }
  
  // 畫素材
  ctx.fillStyle="red";
  for(let i=obstacles.length-1; i>=0; i--){
    let o=obstacles[i];
    o.x-=3;
    ctx.beginPath();
    ctx.arc(o.x, o.y, o.r, 0, Math.PI*2);
    ctx.fill();
    
    // 碰撞判定
    if(player.x < o.x+o.r && player.x+player.w > o.x-o.r &&
       player.y < o.y+o.r && player.y+player.h > o.y-o.r){
        obstacles.splice(i,1);
        showQuestion();
    }
    
    if(o.x<-20) obstacles.splice(i,1);
  }
  
  requestAnimationFrame(gameLoop);
}

function showQuestion(){
  if(score>=3) return; 
  currentQuestion = questions[Math.floor(Math.random()*questions.length)];
  document.getElementById("question").innerText = currentQuestion.q;
  document.getElementById("quizBox").style.display="block";
}

function checkAnswer(){
  let ans = document.getElementById("answer").value.trim();
  if(ans===currentQuestion.a){
    alert("答對了！");
    score++;
    if(score>=3){
      document.getElementById("quizBox").style.display="none";
      document.getElementById("passScreen").style.display="block";
      return;
    }
  } else {
    alert("答錯了，再試一次！");
  }
  document.getElementById("answer").value="";
  document.getElementById("quizBox").style.display="none";
}

function checkPasscode(){
  let code = document.getElementById("passcode").value;
  if(code==="1234"){
    document.getElementById("passMessage").innerText="✅ 恭喜完成遊戲！";
    sendToGoogleSheet(); // 🎯 成功後送資料
  } else {
    document.getElementById("passMessage").innerText="❌ 通行碼錯誤！";
  }
}

// ✅ 把完成紀錄送到 Google 試算表
function sendToGoogleSheet(){
  fetch("https://script.google.com/macros/s/AKfycbzdh9WwBy5GpEp6t_EzsQ1GIFKhAuwQ8nIMnfUlquwbyd1cSlhpXH8VjEvWElFPeqA/exec", {
      method: "POST",
      body: JSON.stringify({
          player: "Player_" + Date.now()
      })
  })
  .then(res => res.text())
  .then(txt => console.log("✅ 已送出資料：" + txt))
  .catch(err => console.error("❌ 上傳失敗", err));
}

gameLoop();
</script>
</body>
</html>
